# SUIperCHAT サービス要件定義

## 1. 全体アーキテクチャ

### 1.1. システム構成
- フロントエンド: 視聴者向けWeb UI
- バックエンド: リアルタイム通信および取引管理システム
- 配信者側ローカルサーバー: OBS連携用
- ブロックチェーン連携: SUI SDK統合

### 1.2. 基本フロー
- 視聴者: 配信閲覧 → SUIperCHAT接続 → ウォレット連携 → 投げ銭実行
- 配信者: OBSにブラウザソース設定 → 投げ銭/コメント表示

## 2. 視聴者向け機能

### 2.1. 技術構成
- フロントエンド: TypeScript, Next.js, shadcn UI
- レスポンシブデザイン（モバイルファースト）
- ダークモード対応

### 2.2. ウォレット連携
- SUI Wallet接続機能
- 配信者が提供したリンクから自動的に送金先ウォレットアドレスを取得（編集不可）

### 2.3. スーパーチャット機能
- 金額選択UI (送金なし、または1SUI/3SUI/5SUI/10SUIから選択､将来的に変更も可能)
- メッセージ入力フィールド
- 表示名入力フィールド（視聴者が任意の名前を設定可能）
- 送信確認・完了通知
- 送信履歴表示

#### 2.3.1. メッセージ処理フロー
- **スパチャなしの場合**:
  - 表示名・メッセージのみ入力
  - WebSocketでデータ送信
  - 配信者側でメッセージ表示

- **スパチャありの場合**:
  - 表示名・メッセージ入力と金額選択
  - SUIウォレットでコントラクト実行（送金）
  - 送金成功時のみWebSocketで「メッセージ + 金額 + トランザクションハッシュ」を送信
  - 配信者側でスパチャ強調表示

### 2.4. UI/UX要件
- シンプルな操作フロー（ウォレット接続→金額選択→コメント入力→送信）
- 配信プラットフォームとの行き来を考慮した設計

## 3. 配信者向け機能

### 3.1. 技術構成
- Rust + Tauriによるデスクトップアプリケーション
  - **Tauriアーキテクチャ**: RustバックエンドとWebViewフロントエンドの組み合わせ
  - **軽量設計**: Electronより約1/10のメモリ使用量
  - **セキュリティ**: 最小権限原則に基づいたセキュアなIPC通信

#### 3.1.1. バックエンド実装（Rust）
- **WebSocketサーバー (actix-webベース)**
  - `actix-web` フレームワークと `actix-web-actors` を利用し、`tokio` ランタイム上で動作する非同期WebSocket機能を提供。
  - `actix` アクターモデルを採用し、各クライアントのWebSocket接続を独立したアクター (`Actor`) として管理。これにより、多数の同時接続を効率的に処理。
  - 視聴者からのメッセージをリアルタイムで各接続アクターが受信し、`StreamHandler` トレイトを実装したアクター内でハンドリング。
  - 受信したメッセージタイプ（通常メッセージ/スパチャなど `ws::Message` の各形式）に応じて、アクター内で適切な処理ロジックに分岐。

- **接続管理機能**
  - 最大接続数制限設定（デフォルト値と管理画面からの調整機能）
  - 新規接続のキューイング処理（最大接続数超過時）
  - 優先処理ロジック（スパチャを含むメッセージを優先的に処理）
  - 接続状況のリアルタイムモニタリング

- **HTTPサーバー (actix-web)**
  - WebSocket機能と同じ `actix-web` フレームワークを利用してローカルHTTPサーバーを構築。
  - OBSブラウザソース用のHTML/CSS/JavaScriptといった静的ファイルを配信する機能を提供 (`actix_files` サービスなどを活用)。
  - (WebSocketとの連携) 必要に応じてHTTPエンドポイント（APIなど）とWebSocketアクター間で情報や状態を共有し、リアルタイムなUI更新等に活用。
  - 配信者が設定を行うためのAPIエンドポイントや、サーバーの状態を確認するエンドポイントなどを提供することも可能。

- **SQLiteデータベース**
  - ローカルSQLiteによる配信セッションごとのメッセージ記録
  - スパチャ履歴の永続化と閲覧機能
  - メッセージのフィルタリングと検索機能

- **SUI連携**
  - RustベースのSUI SDK活用またはJSON-RPC実装
  - トランザクション検証処理
  - ウォレット情報の安全な管理

#### 3.1.2. フロントエンド実装（WebView）
- **UI技術**
  - Next.js (Reactフレームワーク)
  - TypeScript
  - shadcn/ui (UIコンポーネントライブラリ)
  - Tailwind CSS (shadcn/uiが内部で使用)

- **IPC通信**
  - TauriのJavaScript API (`@tauri-apps/api/core`の`invoke`関数) を使用したRustバックエンドとの通信
  - 最小権限原則に基づいたセキュアな連携

#### 3.1.3. パフォーマンスとリソース
- **軽量動作**: 配信中のシステムリソース消費を最小化
- **起動速度**: 高速起動によるスムーズな配信準備
- **バイナリサイズ**: 最適化された単一バイナリパッケージ

#### 3.1.4. パッケージングと配布
- Windows/macOS向けネイティブバイナリ生成
- 自動更新機能（設定により有効化）
- デジタル署名によるセキュリティ確保

### 3.2. OBS連携
- ブラウザソース用URL生成
- 表示設定カスタマイズ画面
- 配信者固有のリンク生成（送金先ウォレットアドレスを含む）

### 3.3. スーパーチャット表示
- 金額に応じた表示スタイル変更
- 表示時間・アニメーション設定
- フォント・色・サイズ等のカスタマイズ

### 3.4. 管理機能
- 受信履歴管理
- NG設定 (特定アドレスのブロック等)
- 集計・分析機能

#### 3.4.1. データベース管理
- **Prisma スキーマ**: (`prisma/schema.prisma` より)
  ```prisma
  // 配信セッション情報を格納するモデル
  model StreamSession {
    id            String    @id @default(cuid()) /// 配信セッションの一意なID (CUID形式)
    streamerId    String    /// 配信者のID
    startTime     DateTime  @default(now()) /// 配信開始日時
    endTime       DateTime? /// 配信終了日時 (null許容)
    viewerLink    String    @unique /// 視聴者共有用リンク
    obsSourceLink String    @unique /// OBSブラウザソース用リンク
    isActive      Boolean   @default(true) /// セッションがアクティブかどうか
    createdAt     DateTime  @default(now()) /// 作成日時
    updatedAt     DateTime  @updatedAt /// 更新日時
    messages      Message[] /// このセッションに関連するメッセージ (リレーション)

    @@index([streamerId]) /// 配信者IDによるインデックス
    @@index([isActive]) /// アクティブ状態によるインデックス
  }

  // メッセージ情報を格納するモデル
  model Message {
    id             String        @id @default(cuid()) /// メッセージの一意なID (CUID形式)
    sessionId      String        /// 関連する配信セッションID
    walletAddress  String?       /// 送信者のウォレットアドレス (null許容)
    displayName    String        /// 視聴者が入力した表示名
    messageContent String        /// メッセージ内容
    amount         Float?        /// スパチャ金額（スパチャなしはnull）
    txHash         String?       /// トランザクションハッシュ（スパチャなしはnull）
    timestamp      DateTime      @default(now()) /// メッセージ送信日時
    streamSession  StreamSession @relation(fields: [sessionId], references: [id], onDelete: Cascade) /// 関連する配信セッション (リレーション)

    @@index([sessionId]) /// セッションIDによるインデックス
    @@index([walletAddress]) /// ウォレットアドレスによるインデックス
    @@index([timestamp]) /// タイムスタンプによるインデックス
  }

  // NG設定（ブロックリスト）を格納するモデル
  model Blocklist {
    id            String   @id @default(cuid()) /// ブロックリストエントリの一意なID (CUID形式)
    walletAddress String   @unique /// ブロックするウォレットアドレス
    reason        String?  /// ブロック理由 (null許容)
    createdAt     DateTime @default(now()) /// 作成日時
    updatedAt     DateTime @updatedAt /// 更新日時
  }

  // 配信者の設定情報を格納するモデル
  model StreamerSettings {
    id             String   @id @default(cuid()) /// 設定の一意なID (CUID形式)
    streamerId     String   @unique /// 配信者のID (ユニーク制約)
    walletAddress  String   /// 配信者のSUIウォレットアドレス
    theme          String?  /// 表示テーマ (null許容)
    styleSettings  Json?    /// 表示スタイル設定 (JSON形式, null許容)
    createdAt      DateTime @default(now()) /// 作成日時
    updatedAt      DateTime @updatedAt /// 更新日時
  }
  ```

- **セッション管理**:
  - 配信ごとに一意のセッションIDを生成
  - 配信開始/終了時間の記録
  - セッション単位での統計情報集計

- **履歴閲覧機能**:
  - 過去の配信セッション一覧表示
  - セッションごとのスパチャ/メッセージ履歴表示
  - スパチャ額・件数などの集計情報

- **エクスポート機能**:
  - CSVフォーマットでの履歴エクスポート
  - 定期的なバックアップ（オプション）

### 3.5. 配信者向けアプリケーション操作フロー（初心者向け）

#### 3.5.1. アプリのインストールと起動
- 単一バイナリ形式で配布（Windows: .exe、Mac: .dmg、Linux: .AppImage）
- インストール不要で実行可能なポータブル設計
- 起動時にシンプルなダッシュボード画面を表示

#### 3.5.2. 初期設定（最初の1回のみ）
- SUIウォレットアドレス設定（送金先アドレス）
- スーパーチャット表示のテーマ・スタイル設定
- 設定内容の自動保存と次回起動時の読み込み

#### 3.5.3. 配信開始時の操作
- アプリ画面の「サーバー開始」ボタンでローカルサーバー起動
- 自動生成されるOBS用URL（例: `http://localhost:3000/overlay?theme=dark&walletAddress=0x123...abc`）
- ワンクリックでURLをクリップボードにコピー

#### 3.5.4. OBSへの設定
- OBSのソース欄で「ブラウザ」ソースを追加
- アプリからコピーしたURLを設定欄に貼り付け
- 幅/高さを配信解像度に合わせて設定
- 必要に応じてCSS等でカスタマイズ可能

#### 3.5.5. 視聴者共有用リンク
- アプリ内で「視聴者リンク生成」機能
- 自動生成される視聴者向けURL（例: `https://suiperchat.app/chat?streamer=0x123...abc`）
- 配信説明欄やSNSでの共有用にコピー機能

#### 3.5.6. トラブルシューティング対応
- 接続テスト機能によるOBSとの連携確認
- ブラウザソース更新ボタンによる強制リフレッシュ
- ファイアウォール許可の簡易ガイド

## 4. ブロックチェーン連携

### 4.1. 技術構成
- SUI SDK
- スマートコントラクト（Move言語）

### 4.2. トランザクション処理
- SUI送金処理
- 手数料設定・計算
- トランザクション検証

#### 4.2.1. 送金フロー
- 視聴者が選択した金額（1SUI/3SUI/5SUI/10SUI）に基づく処理
- SUIブロックチェーン上での送金トランザクション実行
- 視聴者が負担するコスト: 選択金額 + gas代
- トランザクション成功確認後のメッセージ送信

### 4.3. コントラクト機能
- スマートコントラクト設計
- 手数料分配ロジック

#### 4.3.1. 運営インセンティブ機能
- **分配比率の設計**
  - 運営への一定割合の自動送金（例: 5%）
  - 配信者への残額送金（例: 選択金額の95%）
  - 割合の変更可能性（管理者のみ）

- **実装例**
  - 視聴者が10SUIを選択した場合:
    - 運営へ0.5SUI送金（5%）
    - 配信者へ9.5SUI送金（95%）
    - 視聴者は10SUI + gas代を支払い

- **透明性の確保**
  - 手数料率の視聴者向け明示
  - トランザクションの検証可能性
  - ブロックチェーン上での完全な透明性

#### 4.3.2. スマートコントラクト要件
- Move言語による実装
- SUIブロックチェーンの特性を活かした効率的なガス使用
- 自動分配処理の信頼性と安全性確保
- 将来的な手数料率変更に対応可能な設計

## 5. セキュリティ・技術要件

### 5.1. セキュリティ
- ウォレット連携の安全性確保
- DDoS対策
- データ暗号化

### 5.2. パフォーマンス
- リアルタイム通信の低遅延化
- 同時接続数対応
- OBS連携時の軽量処理

#### 5.2.1. 負荷対策
- **接続制限メカニズム**
  - PCスペックに応じた最大同時接続数の自動調整
  - 標準的な事務用PCの場合、安全値として50〜100接続程度を想定
  - 高負荷検知時の自動制限機能

- **メッセージキューイング**
  - メッセージ受信バッファの実装
  - 処理優先度: スパチャメッセージ > 通常メッセージ
  - バースト時のスロットリング処理

- **リソース最適化**
  - 非アクティブ接続の自動切断（タイムアウト設定）
  - メモリ使用量の定期モニタリングと警告機能
  - 極端な高負荷時の安全モード（スパチャのみ表示など）

- **拡張性**
  - 将来的な大規模配信対応のための中継サーバーモード（オプション）
  - メッセージ集約機能（同一ユーザーからの連続メッセージをまとめるなど）

## 6. 将来拡張性

### 6.1. 機能拡張
- 複数ウォレット対応
- NFT連携機能
- 独自トークン発行連携
- カスタム金額設定オプション

### 6.2. プラットフォーム連携
- 複数の配信プラットフォーム対応
- 配信プラットフォームAPIとの連携可能性
